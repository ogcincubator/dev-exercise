variables:
  DOCKER_DRIVER: overlay2

stages:
  - deploy

image:
  name: docker:23.0.5

services:
  - docker:23.0.5-dind

deploy:
  stage: deploy
  before_script:
      - apk add --no-cache python3 py3-pip
      - python3 -m venv venv
      - source venv/bin/activate
      - pip install --no-cache-dir pytest requests
  
  script:
    - source venv/bin/activate
    - docker compose -f "docker-compose.yml" up -d --build
    - pytest -v --tb=no tests/test-api.py
  after_script:
    - docker-compose -f "docker-compose.yml" down
